<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>CloudHop Unity Spectrum</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        #unity-container { width: 100%; height: 100vh; display: block; }
        #unity-canvas { width: 100%; height: 100%; display: block; }
        #loading-bar { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 20px; background: #333; border-radius: 10px; overflow: hidden; }
        #loading-bar .bg { width: 100%; height: 100%; background: linear-gradient(90deg, #00f, #f0f); }
        #loading-bar .fill { height: 100%; width: 0%; background: #fff; transition: width 0.3s; }
    </style>
</head>
<body>
    <div id="unity-container">
        <div id="loading-bar">
            <div class="bg"></div>
            <div class="fill" id="loading-fill"></div>
        </div>
        <canvas id="unity-canvas"></canvas>
    </div>

    <script>
        var unityInstance = null;
        
        function createUnityInstance(canvas, config, onProgress) {
            return new Promise((resolve, reject) => {
                if (typeof createUnityInstance !== 'undefined') {
                    createUnityInstance(canvas, config, onProgress).then(instance => {
                        unityInstance = instance;
                        resolve(instance);
                    }).catch(reject);
                } else {
                    // Fallback for older builds
                    var Module = {
                        canvas: canvas,
                        dataUrl: "Build/CloudHopSpectrum.data",
                        frameworkUrl: "Build/CloudHopSpectrum.framework.js",
                        codeUrl: "Build/CloudHopSpectrum.wasm",
                        streamingAssetsUrl: "StreamingAssets",
                        companyName: "CloudHop",
                        productName: "Unity Spectrum",
                        productVersion: "1.0",
                        showBanner: function(msg, type) {
                            var banner = document.getElementById('loading-bar');
                            banner.style.display = type === 'error' ? 'none' : 'block';
                        }
                    };
                    
                    var script = document.createElement('script');
                    script.src = Module.frameworkUrl;
                    script.onload = () => resolve(Module);
                    document.body.appendChild(script);
                }
            });
        }

        // Initialize Unity
        window.addEventListener('load', async () => {
            const container = document.getElementById('unity-container');
            const canvas = document.getElementById('unity-canvas');
            const loadingFill = document.getElementById('loading-fill');
            
            const config = {
                dataUrl: "Build/CloudHopSpectrum.data",
                frameworkUrl: "Build/CloudHopSpectrum.framework.js", 
                codeUrl: "Build/CloudHopSpectrum.wasm",
                streamingAssetsUrl: "StreamingAssets",
                companyName: "CloudHop",
                productName: "Unity Spectrum",
                productVersion: "1.0",
                showBanner: function(msg, type) {
                    const color = type === 'error' ? 'red' : 'green';
                    console.log(`[Unity] ${msg} (${type})`);
                }
            };

            try {
                const instance = await createUnityInstance(canvas, config, (progress) => {
                    loadingFill.style.width = (progress * 100) + '%';
                });
                
                // Hide loading bar
                document.getElementById('loading-bar').style.display = 'none';
                
                // Expose Unity methods to window for React communication
                window.UnityBridge = {
                    SendSpectrumData: function(data) {
                        if (instance && instance.SendMessage) {
                            instance.SendMessage('SpectrumController', 'ReceiveSpectrumData', data);
                        }
                    },
                    SendUnityReady: function() {
                        window.parent.postMessage({ type: 'unity', message: 'ready' }, '*');
                    }
                };

                // Notify React that Unity is ready
                setTimeout(() => {
                    if (window.UnityBridge.SendUnityReady) {
                        window.UnityBridge.SendUnityReady();
                    }
                }, 1000);

            } catch (error) {
                console.error('Unity initialization failed:', error);
                document.getElementById('loading-bar').innerHTML = '<div style="color: red; text-align: center; padding: 20px;">Failed to load Unity WebGL build</div>';
            }
        });

        // Handle messages from React
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'spectrum') {
                if (window.UnityBridge && window.UnityBridge.SendSpectrumData) {
                    window.UnityBridge.SendSpectrumData(JSON.stringify(event.data.payload));
                }
            }
        });
    </script>
</body>
</html>